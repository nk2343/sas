libname demo '/folders/myfolders/eee';

data demo_trt;
merge demo.admin_(in=a) demo.vsigns_(in=b);
by PATIENT;
if a and b;
run;

proc export data=demo_trt 
   outfile='/folders/myfolders/eee/trt.csv'
   dbms=csv
   replace;
run; 

proc import datafile='/folders/myfolders/eee/trt.csv' 
 out=demo_trt_fixtime  
 dbms=csv    
 replace;
run;


data demo_trt_datetime;
set demo_trt_fixtime;
vdateyear = Substr(Strip(put(vdate,MMDDYY10.)),7,4);
vdatemonth = Substr(Strip(put(vdate,MMDDYY10.)),1,2);
vdateday = Substr(Strip(put(vdate,MMDDYY10.)),4,2);
vtimehh=scan(Strip(put(vtime,TIME20.)),1,':');
vtimemm=scan(Strip(put(vtime,TIME20.)),2,':');
vdate_num=input(CAT(strip(vdateyear),strip(vdatemonth),strip(vdateday)),YYMMDD10.);
datetime_num=dhms(vdate_num,strip(put(vtimehh,bset.)),strip(put(vtimemm,best.)),0);
datetime15=put(datetime_num,datetime.);

adateyear = Substr(Strip(put(dateadmn,MMDDYY10.)),7,4);
adatemonth = Substr(Strip(put(dateadmn,MMDDYY10.)),1,2);
adateday = Substr(Strip(put(dateadmn,MMDDYY10.)),4,2);
atimehh=scan(Strip(put(timeadmn,TIME20.)),1,':');
atimemm=scan(Strip(put(timeadmn,TIME20.)),2,':');
adate_num=input(CAT(strip(adateyear),strip(adatemonth),strip(adateday)),YYMMDD10.);
adatetime_num=dhms(adate_num,strip(put(atimehh,bset.)),strip(put(atimemm,best.)),0);
adatetime15=put(adatetime_num,datetime.);
run;


proc sql;
create table  trt_baseline as
   select patient, systol as systol0, diastol as diastol0, hrtrate as hrtrate0, 
 ctemp as ctemp0,resprate as resprate0 
          
      from demo_trt_datetime
      having datetime_num<adatetime_num and datetime_num ne .;
      quit;
      
data baseline_merge;
merge trt_baseline(in=a) demo_trt_datetime(in=b);
by PATIENT;
if a and b;
run; 
  
    
/*data diff;
set baseline_merge;
if (diastol-diastol0)/diastol0>0.2 then dis+1;
if (diastol-diastol0)/diastol0<-0.2 then ndis+1;
if (systol-systol0)/systol0>0.2 then sys+1; 
if (diastol-diastol0)/diastol0<-0.2 then nsys+1;
if (hrtrate-hrtrate0)/hrtrate0>0.2 then hrt+1; 
if (hrtrate-hrtrate0)/hrtrate0<-0.2 then nhrt+1;
if (ctemp-ctemp0)/ctemp0>1 then ct+1; 
if (ctemp-ctemp0)/ctemp0<-1 then nct+1;
if (resprate-resprate0)/resprate0>1 then res+1; 
if (resprate-resprate0)/resprate0<-1 then nres+1;
run;
*/
data baseline_merge;
set baseline_merge;
resprate_=input(resprate, best.);
resprate0_=input(resprate0, best.);
run; 

Proc sql;
create table diff as
select *,
case when (systol-systol0)/systol0>0.2 and systol ne . and systol0 ne . then 1
     when systol0= . or systol = . then .
    else 0
    end as sys,
case when (systol-systol0)/systol0<-0.2 and systol ne . and systol0 ne . then 1
     when systol0= . or systol = . then .
    else 0
    end as nsys, 
case when (diastol-diastol0)/diastol>0.2 and diastol ne . and diastol0 ne . then 1
       when diastol0= . or diastol = . then .
   else 0
    end as dis,
case when (diastol-diastol0)/diastol0<-0.2 and diastol ne . and diastol0 ne . then 1
    when diastol0= . or diastol = . then .
    else 0
    end as ndis,
case when (hrtrate-hrtrate0)/hrtrate0>0.2 and hrtrate ne . and hrtrate0 ne . then 1
    when hrtrate0= . or hrtrate = . then .
    else 0
    end as hrt, 
case when (hrtrate-hrtrate0)/hrtrate0<-0.2 and hrtrate ne . and hrtrate0 ne . then 1
    when hrtrate0= . or hrtrate = . then .
    else 0
    end as nhrt,
case when ctemp-ctemp0>1 and ctemp ne . and ctemp0 ne . then 1
    when ctemp= . or ctemp0 = . then .
    else 0
    end as ct,
case when ctemp-ctemp0<-1 and ctemp ne . and ctemp0 ne . then 1
    when ctemp= . or ctemp0 = . then .
    else 0
    end as nct,
case when (resprate_-resprate0_)/resprate0_>0.2 and resprate_ ne . and resprate0_ ne . then 1
   when resprate_= . or resprate0_ = . then .
   else 0
    end as res, 
case  when (resprate_-resprate0_)/resprate0_<-0.2 and resprate_ ne . and resprate0_ ne . then 1
    when resprate_= . or resprate0_ = . then .
    else 0
    end as nres
from baseline_merge;
quit;

proc sql;
create table diff_cnt as
select *, 
sum(sys) as syssum,sum(nsys) as nsyssum,sum(dis) as dissum,sum(ndis) as ndissum,
sum(hrt) as hrtsum,sum(nhrt) as nhrtsum,sum(res) as ressum,sum(nres) as nressum,
sum(ct) as ctsum, sum(nct) as nctsum
from diff
group by patient;
quit; 

proc sort data=diff_cnt nodupkey out=diff_cnt_nodup;
by patient syssum ;
run;

data diff_count;
set diff_cnt_nodup;
if syssum>0 then syssum=1;
if nsyssum>0 then nsyssum=1;
if dissum>0 then dissum=1;
if ndissum>0 then ndissum=1;
if hrtsum>0 then hrtsum=1;
if nhrtsum>0 then nhrtsum=1;
if ressum>0 then ressum=1;
if nressum>0 then nressum=1;
if ctsum>0 then ctsum=1;
if nctsum>0 then nctsum=1;
run;

proc sql;
create table diff_sumcount as
select *,
sum(syssum) as insys, sum(nsyssum) as desys,
sum(dissum) as indis, sum(ndissum) as dedis,
sum(hrtsum) as inhrt, sum(nhrtsum) as dehrt,
sum(ressum) as inres, sum(nressum) as deres,
sum(ctsum) as inct, sum(nctsum) as dect
from diff_count;
quit;


proc sql;
create table diff_cnt as
select *, 
sum(dis)
from diff
group by patient;
quit;



/* 
     or (systol-systol0)/diastol0<-0.2
     or (diastol-diastol0)/diastol>0.2 
     or (diastol-diastol0)/diastol0<-0.2
	or (hrtrate-hrtrate0)/hrtrate0>0.2
	or (hrtrate-hrtrate0)/hrtrate0<-0.2
	or (ctemp-ctemp0)/ctemp0>1
	or (ctemp-ctemp0)/ctemp0<-1
	or (resprate-resprate0)/resprate0>1
	or (resprate-resprate0)/resprate0<-1
    order by patient*/
